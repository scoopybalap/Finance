<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utang-Piutang Saya (Personal Finance Tracker)</title>
    

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> 
    <style>
        body { 
            font-family: sans-serif; 
            margin: 0; 
            background-color: #f4f4f9; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        .header { 
            background-color: #007bff; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        
        .container { 
            max-width: 450px; 
            width: 100%; 
            margin: 0 auto; 
            background: white; 
            padding: 15px; 
            border-radius: 0; 
            box-shadow: none; 
            flex-grow: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 70px; 
        }
        
        /* Navigasi Footer/Tab */
        .navigation { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            max-width: 450px; 
            left: 50%;
            transform: translateX(-50%);
            background-color: #343a40; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .nav-item { 
            color: #ccc; 
            text-align: center; 
            flex-grow: 1;
            padding: 5px 0;
            cursor: pointer;
            transition: color 0.3s, background-color 0.3s; 
        }
        .nav-item:hover, .nav-item.active { 
            color: #007bff; 
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-item h4 { margin: 0; font-size: 0.8em; } 
        
        /* Gaya Halaman dan Dashboard */
        .page { 
            display: none; 
        } 
        .page.active { display: block; }
        h2 { 
            border-bottom: 2px solid #ccc; 
            padding-bottom: 10px; 
            color: #333; 
            margin-top: 0; 
            font-size: 1.3em; 
            margin-bottom: 15px; 
        } 
        
        #mainDashboard {
            display: flex;
            flex-wrap: wrap; 
            justify-content: space-around; 
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #e9ecef;
        }
        .summary-card {
            flex-basis: 30%; 
            padding: 8px 4px; 
            border-radius: 4px;
            text-align: center;
            margin-bottom: 10px; 
        }
        .summary-card h3 { margin-top: 0; font-size: 0.7em; color: #555; } 
        .summary-card p { font-size: 1.1em; font-weight: bold; margin: 3px 0 0; } 
        
        .card-piutang { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .card-utang { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .card-networth { background-color: #fff3cd; border: 1px solid #ffeeba; }

        /* Gaya untuk Ringkasan Saldo */
        .saldo-ringkasan {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 10px;
            text-align: center;
        }
        .saldo-item {
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .saldo-item h4 { margin-top: 0; color: #555; font-size: 0.9em; }
        .saldo-awal { background-color: #e0f7fa; }
        .saldo-akhir { background-color: #ccffcc; }
        .net-worth-ringkasan { grid-column: 1 / 2; padding: 15px; font-size: 1.2em; font-weight: bold; background-color: #ffe0b2; border-radius: 8px; margin-top: 10px; }
        
        @media (min-width: 400px) {
            .saldo-ringkasan {
                grid-template-columns: 1fr 1fr;
            }
            .net-worth-ringkasan {
                grid-column: 1 / 3;
            }
        }

        #chartArea {
            max-width: 100%; 
            height: 250px; 
            margin: 15px auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #chartArea p {
            margin: 0;
            padding: 10px;
        }

        /* Form dan List Styles */
        form div { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.9em; }
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
            font-size: 1em; 
        }
        button { 
            padding: 10px 15px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px; 
            font-size: 0.9em; 
        }
        button:hover { background-color: #0056b3; } 

        .transaction { 
            padding: 12px; 
            margin-bottom: 8px; 
            border-left: 4px solid; 
            background-color: #fff; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border-radius: 4px; 
        }
        .transaction.lunas {
            border-left-color: #adb5bd !important; /* Abu-abu untuk lunas */
            opacity: 0.7; /* Sedikit transparan */
            background-color: #f8f9fa;
        }

        .transaction p { margin: 5px 0; } 
        .utang { border-left-color: #dc3545; } 
        .piutang { border-left-color: #28a745; } 
        .due-date { font-weight: bold; color: #ffc107; font-size: 0.9em; } 
        .installments { font-size: 0.8em; color: #555; margin-top: 5px; border-top: 1px dashed #eee; padding-top: 5px; } 
        
        #installmentEstimate {
            padding: 10px;
            background-color: #e9f7ef;
            border: 1px solid #d4edda;
            border-radius: 4px;
            margin-top: 15px;
            font-weight: bold;
            display: none; 
            color: #28a745;
            font-size: 0.95em; 
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Pencatat Keuangan Pribadi</h1>
    </div>

    <div class="container">
        
        <div id="homePage" class="page active">
            <h2>Ringkasan Total Aktif üìä</h2>
            <div id="mainDashboard">
                </div>
            
            <h2>Status Piutang (Grafik) üìà</h2>
            <div id="chartArea">
                <canvas id="piutangChart"></canvas>
            </div>
        </div>
        
        <div id="formPage" class="page">
            <h2>Tambah Transaksi Baru ‚ûï</h2>
            <form id="transactionForm">
                <div>
                    <label for="type">Tipe Transaksi:</label>
                    <select id="type" required>
                        <option value="piutang">Piutang (Orang Lain Berutang Kepada Saya)</option>
                        <option value="utang">Utang (Saya Berutang Kepada Orang Lain)</option>
                    </select>
                </div>
                <div>
                    <label for="person">Nama Pihak/Orang:</label>
                    <input type="text" id="person" required>
                </div>
                <div>
                    <label for="principal">Jumlah Pokok (Rp):</label>
                    <input type="text" id="principal" required onkeyup="formatInputRupiah(this); updateInstallmentEstimate()">
                </div>
                <div>
                    <label for="interestRate">Suku Bunga (% per Bulan):</label>
                    <input type="text" id="interestRate" min="0" value="0" required onkeyup="updateInstallmentEstimate()"> 
                </div>
                <div>
                    <label for="installmentsCount">Jumlah Cicilan (Bulan):</label>
                    <input type="number" id="installmentsCount" min="1" value="1" required onchange="updateInstallmentEstimate()">
                </div>
                <div id="installmentEstimate"></div>
                <div>
                    <label for="dueDate">Tanggal Jatuh Tempo Terakhir:</label>
                    <input type="date" id="dueDate" required>
                </div>
                <button type="submit">Catat Transaksi</button>
            </form>
        </div>

        <div id="piutangPage" class="page">
            <h2>Daftar Piutang Aktif Saya ‚úÖ</h2>
            <div id="piutangList">
                <p>Memuat data piutang...</p>
            </div>
        </div>

        <div id="utangPage" class="page">
            <h2>Daftar Utang Aktif Saya ‚ùå</h2>
            <div id="utangList">
                <p>Memuat data utang...</p>
            </div>
        </div>
        
        <div id="historyPage" class="page">
            <h2>Riwayat Lunas (Piutang & Utang) üìú</h2>
            <div id="historyList">
                <p>Memuat riwayat lunas...</p>
            </div>
        </div>

        <div id="summaryPage" class="page">
            <h2>Ringkasan Saldo Awal dan Akhir üëë</h2>
            <div id="balanceSummary" class="saldo-ringkasan">
                </div>
        </div>

    </div>

    <div class="navigation">
        <div class="nav-item active" data-page="homePage">
            <h4>üè† Beranda</h4>
        </div>
        <div class="nav-item" data-page="formPage">
            <h4>‚ûï Tambah</h4>
        </div>
        <div class="nav-item" data-page="piutangPage">
            <h4>‚úÖ Piutang</h4>
        </div>
        <div class="nav-item" data-page="utangPage">
            <h4>‚ùå Utang</h4>
        </div>
        <div class="nav-item" data-page="historyPage">
            <h4>üìú Riwayat</h4>
        </div>
        <div class="nav-item" data-page="summaryPage">
            <h4>üëë Ringkasan</h4>
        </div>
    </div>

<script>
    let transactions = [];
    const form = document.getElementById('transactionForm');
    const mainDashboard = document.getElementById('mainDashboard');
    const balanceSummaryContainer = document.getElementById('balanceSummary');
    const piutangListContainer = document.getElementById('piutangList');
    const utangListContainer = document.getElementById('utangList');
    const historyListContainer = document.getElementById('historyList'); // ELEMEN BARU
    const navItems = document.querySelectorAll('.nav-item');
    
    // Ambil elemen form
    const principalInput = document.getElementById('principal');
    const interestRateInput = document.getElementById('interestRate');
    const installmentsCountInput = document.getElementById('installmentsCount');
    const estimateDiv = document.getElementById('installmentEstimate');

    let piutangChartInstance = null; 

    // ===================================
    // 1. MANAJEMEN DATA & LOCAL STORAGE
    // ===================================

    function loadTransactions() {
        const storedTransactions = localStorage.getItem('personalFinanceTracker');
        if (storedTransactions) {
            transactions = JSON.parse(storedTransactions); 
        }
    }

    function saveTransactions() {
        localStorage.setItem('personalFinanceTracker', JSON.stringify(transactions));
    }

    // ===================================
    // 2. FUNGSI UTILITAS
    // ===================================

    function formatInputRupiah(inputElement) {
        let angka = inputElement.value.replace(/\D/g, ''); 
        if (!angka || angka === '0') {
            inputElement.value = '';
            return;
        }
        let formatted = new Intl.NumberFormat('id-ID').format(angka);
        inputElement.value = formatted;
    }

    function formatCurrency(amount) {
        const roundedAmount = Math.round(parseFloat(amount)); 
        return roundedAmount.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function cleanInterestRate(input) {
        return input.replace(/,/g, '.').replace(/[^0-9.]/g, ''); 
    }

    function calculateTotal(principal, rate, installmentsCount) {
        const principalAmount = parseFloat(principal); 
        const interestRate = parseFloat(rate) / 100; 
        const installments = parseInt(installmentsCount);
        
        if (isNaN(principalAmount) || isNaN(interestRate) || isNaN(installments) || installments === 0) {
            return { totalInterest: 0, totalAmount: 0, totalPerInstallment: 0, principalPerInstallment: 0 };
        }
        
        const totalInterest = principalAmount * interestRate * installments;
        const totalAmount = principalAmount + totalInterest;

        const principalPerInstallment = principalAmount / installments;
        const interestPerInstallment = totalInterest / installments;
        const totalPerInstallment = principalPerInstallment + interestPerInstallment;
        
        return {
            totalInterest: totalInterest,
            totalAmount: totalAmount,
            totalPerInstallment: totalPerInstallment,
            principalPerInstallment: principalPerInstallment,
        };
    }
    
    function getFinancialTotals() {
        let totalPiutangAwal = 0; 
        let sisaPiutang = 0;      
        let totalUtangAwal = 0;   
        let sisaUtang = 0;        

        // Hanya hitung transaksi yang aktif
        const activeTransactions = transactions.filter(tx => tx.status === 'aktif');

        activeTransactions.forEach(tx => {
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const remainingInstallments = tx.installmentsCount - tx.paidInstallments;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;

            if (tx.type === 'piutang') {
                totalPiutangAwal += result.totalAmount; 
                sisaPiutang += remainingTotal;      
            } else if (tx.type === 'utang') {
                totalUtangAwal += result.totalAmount;   
                sisaUtang += remainingTotal;        
            }
        });
        
        const netWorthAwal = totalPiutangAwal - totalUtangAwal;
        const netWorthAkhir = sisaPiutang - sisaUtang;
        
        return {
            totalPiutangAwal, sisaPiutang, 
            totalUtangAwal, sisaUtang,
            netWorthAwal, netWorthAkhir
        };
    }
    
    function updateInstallmentEstimate() {
        const principalFormatted = principalInput.value;
        const principalClean = principalFormatted.replace(/\./g, ''); 
        const rateClean = cleanInterestRate(interestRateInput.value); 
        const installments = parseInt(installmentsCountInput.value);

        if (!principalClean || !rateClean || installments < 1) {
            estimateDiv.style.display = 'none';
            return;
        }

        const result = calculateTotal(principalClean, rateClean, installments);

        if (result.totalPerInstallment > 0) {
            estimateDiv.style.display = 'block';
            estimateDiv.innerHTML = `
                <p style="margin: 0; font-size: 0.9em; color:#0056b3;">
                    Estimasi Cicilan per Bulan (${installments}x): 
                    <strong style="font-size: 1.1em;">Rp ${formatCurrency(result.totalPerInstallment)}</strong>
                    <span style="font-size: 0.8em; color: #555;">(Total akhir: Rp ${formatCurrency(result.totalAmount)})</span>
                </p>
            `;
        } else {
             estimateDiv.style.display = 'none';
        }
    }


    // ===================================
    // 3. FUNGSI RENDER (TAMPILAN)
    // ===================================

    function renderPiutangChart(totalPiutang, sisaPiutang) {
        const ctx = document.getElementById('piutangChart');
        const chartArea = document.getElementById('chartArea');
        
        if (!ctx) return; 

        if (totalPiutang === 0) {
             chartArea.style.height = 'auto';
             chartArea.innerHTML = '<p style="text-align:center; color:#555;">Belum ada Piutang yang dicatat untuk ditampilkan di grafik.</p>';
             return;
        }
        
        chartArea.style.height = '250px'; 
        
        const piutangLunas = totalPiutang - sisaPiutang;
        
        if (piutangChartInstance) {
            piutangChartInstance.destroy();
        }

        piutangChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Piutang Belum Lunas', 'Piutang Sudah Lunas'],
                datasets: [{
                    label: 'Status Piutang',
                    data: [sisaPiutang, piutangLunas],
                    backgroundColor: [
                        'rgba(255, 159, 64, 0.8)', 
                        'rgba(75, 192, 192, 0.8)'  
                    ],
                    borderColor: [
                        'rgba(255, 159, 64, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                plugins: {
                    legend: { position: 'top', labels: { font: { size: 10 } } },
                    title: { display: true, text: 'Persentase Status Piutang', font: { size: 12 } },
                    datalabels: {
                        formatter: (value, context) => {
                            let sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (sum === 0) return '0%'; 
                            let percentage = (value * 100 / sum).toFixed(1) + "%";
                            return percentage;
                        },
                        color: '#fff', 
                        font: { weight: 'bold', size: 10 }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.label || '';
                                if (context.parsed !== null) {
                                    label += ': Rp ' + formatCurrency(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderMainDashboard() {
        const { totalPiutangAwal, sisaPiutang, totalUtangAwal, sisaUtang, netWorthAkhir } = getFinancialTotals();

        mainDashboard.innerHTML = `
            <div class="summary-card card-piutang">
                <h3>Aset (Sisa Piutang)</h3>
                <p>Rp ${formatCurrency(sisaPiutang)}</p>
                <p style="font-size:0.7em; margin-top: 3px;">(Awal: Rp ${formatCurrency(totalPiutangAwal)})</p>
            </div>
            <div class="summary-card card-utang">
                <h3>Liabilitas (Sisa Utang)</h3>
                <p>Rp ${formatCurrency(sisaUtang)}</p>
                <p style="font-size:0.7em; margin-top: 3px;">(Awal: Rp ${formatCurrency(totalUtangAwal)})</p>
            </div>
            <div class="summary-card card-networth">
                <h3>Net Worth (Bersih Aktif)</h3>
                <p>Rp ${formatCurrency(netWorthAkhir)}</p>
                <p style="font-size:0.7em; margin-top: 3px; color:${netWorthAkhir >= 0 ? 'green' : 'red'};">${netWorthAkhir >= 0 ? 'Positif' : 'Negatif'}</p>
            </div>
        `;
        
        renderPiutangChart(totalPiutangAwal, sisaPiutang);
    }
    
    function renderBalanceSummary() {
        const { totalPiutangAwal, sisaPiutang, totalUtangAwal, sisaUtang, netWorthAwal, netWorthAkhir } = getFinancialTotals();
        
        balanceSummaryContainer.innerHTML = `
            <div class="saldo-item saldo-awal">
                <h4>Total Piutang Awal (Assets)</h4>
                <p>Rp ${formatCurrency(totalPiutangAwal)}</p>
            </div>
            <div class="saldo-item saldo-awal">
                <h4>Total Utang Awal (Liabilities)</h4>
                <p>Rp ${formatCurrency(totalUtangAwal)}</p>
            </div>
            <div class="saldo-item saldo-akhir">
                <h4>Sisa Piutang (Assets Aktif)</h4>
                <p>Rp ${formatCurrency(sisaPiutang)}</p>
            </div>
            <div class="saldo-item saldo-akhir">
                <h4>Sisa Utang (Liabilities Aktif)</h4>
                <p>Rp ${formatCurrency(sisaUtang)}</p>
            </div>
            <div class="net-worth-ringkasan" style="background-color: #e0f7fa;">
                Total Net Worth Awal (Saldo Awal)<br>
                <span style="color:${netWorthAwal >= 0 ? 'green' : 'red'};">Rp ${formatCurrency(netWorthAwal)}</span>
            </div>
            <div class="net-worth-ringkasan" style="background-color: #ccffcc;">
                Sisa Net Worth (Saldo Akhir Aktif)<br>
                <span style="color:${netWorthAkhir >= 0 ? 'green' : 'red'};">Rp ${formatCurrency(netWorthAkhir)}</span>
            </div>
        `;
    }

    // FUNGSI RENDER LIST UTAMA (untuk Piutang Aktif dan Utang Aktif)
    function renderTransactionList(type, container) {
        container.innerHTML = ''; 
        // Filter: Tipe = yang diminta DAN Status = aktif
        const filteredTransactions = transactions.filter(tx => tx.type === type && tx.status === 'aktif');

        if (filteredTransactions.length === 0) {
            container.innerHTML = `<p style="text-align: center; color: #555; margin-top: 20px;">Belum ada transaksi ${type} yang aktif dicatat.</p>`;
            return;
        }

        filteredTransactions.forEach((tx, originalIndex) => {
            
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const statusClass = tx.type === 'utang' ? 'utang' : 'piutang';
            
            const transactionDiv = document.createElement('div');
            transactionDiv.classList.add('transaction', statusClass);
            
            const formattedDueDate = new Date(tx.dueDate).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const remainingInstallments = tx.installmentsCount - tx.paidInstallments;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;

            transactionDiv.innerHTML = `
                <p><strong>${tx.type === 'utang' ? 'UTANG kepada' : 'PIUTANG dari'} ${tx.person}</strong></p>
                <p>Pokok: Rp ${formatCurrency(tx.principal)}</p>
                <p>Total Bunga: Rp ${formatCurrency(result.totalInterest)}</p>
                <p><strong>TOTAL AKHIR: Rp ${formatCurrency(result.totalAmount)}</strong></p>
                
                <div class="installments">
                    Cicilan (${tx.installmentsCount}x): 
                    <strong>Rp ${formatCurrency(result.totalPerInstallment)}</strong> per bulan.
                </div>
                
                <p>Dibayar: ${tx.paidInstallments} dari ${tx.installmentsCount} cicilan</p>
                <p>Sisa: Rp ${formatCurrency(remainingTotal)} (${remainingInstallments} cicilan)</p>
                
                <p class="due-date">Jatuh Tempo Terakhir: ${formattedDueDate}</p>
                
                ${remainingInstallments > 0 ? `<button onclick="payInstallment(${transactions.indexOf(tx)})">Bayar Cicilan</button>` : ''}
                <button onclick="markPaid(${transactions.indexOf(tx)})" style="background-color: #6c757d;">Tandai Lunas Penuh</button>
            `;
            container.appendChild(transactionDiv);
        });
    }
    
    // FUNGSI BARU: Render Riwayat Lunas
    function renderHistoryList() {
        historyListContainer.innerHTML = '';
        // Filter: Status = lunas
        const historyTransactions = transactions.filter(tx => tx.status === 'lunas');
        
        if (historyTransactions.length === 0) {
            historyListContainer.innerHTML = `<p style="text-align: center; color: #555; margin-top: 20px;">Belum ada riwayat transaksi lunas.</p>`;
            return;
        }
        
        historyTransactions.forEach(tx => {
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const statusClass = tx.type === 'utang' ? 'utang' : 'piutang';
            
            const transactionDiv = document.createElement('div');
            transactionDiv.classList.add('transaction', statusClass, 'lunas'); // Tambah kelas 'lunas'
            
            const formattedDate = new Date(tx.lunasDate).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

            transactionDiv.innerHTML = `
                <p><strong>[LUNAS] ${tx.type === 'utang' ? 'UTANG kepada' : 'PIUTANG dari'} ${tx.person}</strong></p>
                <p>Pokok: Rp ${formatCurrency(tx.principal)} | Total Akhir: Rp ${formatCurrency(result.totalAmount)}</p>
                <p>Lunas pada: <strong style="color: #333;">${formattedDate}</strong></p>
                <p style="font-size:0.8em; margin-top: 8px;">(Total cicilan ${tx.paidInstallments}x dari ${tx.installmentsCount}x)</p>
                <button onclick="deleteTransaction(${transactions.indexOf(tx)})" style="background-color: #dc3545; padding: 5px 8px; font-size: 0.8em;">Hapus Permanen</button>
            `;
            historyListContainer.appendChild(transactionDiv);
        });
    }

    // ===================================
    // 4. MANAJEMEN APLIKASI (Logic)
    // ===================================

    function payInstallment(index) {
        if (transactions[index].paidInstallments < transactions[index].installmentsCount) {
            transactions[index].paidInstallments++;
            alert(`Cicilan ke-${transactions[index].paidInstallments} untuk ${transactions[index].person} berhasil dibayar.`);
            // Cek apakah cicilan sudah lunas semua setelah pembayaran
            if(transactions[index].paidInstallments === transactions[index].installmentsCount) {
                transactions[index].status = 'lunas';
                transactions[index].lunasDate = new Date().toISOString().slice(0, 10);
                alert(`Selamat! Transaksi ${transactions[index].person} telah lunas penuh!`);
            }
            saveTransactions();
            refreshAllPagesAndCurrentView();
        } else {
            alert(`Semua cicilan untuk ${transactions[index].person} sudah lunas.`);
        }
    }

    function markPaid(index) {
        if (confirm(`Apakah Anda yakin ingin menandai transaksi ${transactions[index].person} lunas penuh?`)) {
            transactions[index].paidInstallments = transactions[index].installmentsCount; // Pastikan paid penuh
            transactions[index].status = 'lunas';
            transactions[index].lunasDate = new Date().toISOString().slice(0, 10); // Catat tanggal lunas
            saveTransactions();
            alert(`Transaksi ${transactions[index].person} berhasil ditandai Lunas Penuh dan dipindahkan ke Riwayat!`);
            refreshAllPagesAndCurrentView();
        }
    }
    
    // FUNGSI BARU: Hapus Permanen dari Riwayat
    function deleteTransaction(index) {
        if (confirm(`Apakah Anda yakin ingin MENGHAPUS PERMANEN riwayat transaksi ${transactions[index].person}? Tindakan ini tidak dapat dibatalkan.`)) {
            transactions.splice(index, 1);
            saveTransactions();
            alert("Riwayat transaksi berhasil dihapus.");
            refreshAllPagesAndCurrentView();
        }
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        const principalFormatted = principalInput.value;
        const principalClean = principalFormatted.replace(/\./g, ''); 
        const interestRateClean = cleanInterestRate(interestRateInput.value);

        const newTransaction = {
            type: document.getElementById('type').value,
            person: document.getElementById('person').value,
            principal: principalClean, 
            interestRate: interestRateClean, 
            installmentsCount: parseInt(installmentsCountInput.value), 
            dueDate: document.getElementById('dueDate').value,
            date: new Date().toISOString().slice(0, 10), 
            paidInstallments: 0,
            status: 'aktif', // TAMBAHAN STATUS BARU
            lunasDate: null // TAMBAHAN TANGGAL LUNAS
        };
        
        if (!newTransaction.principal || parseFloat(newTransaction.principal) < 1 || newTransaction.installmentsCount < 1) {
            alert("Jumlah Pokok dan Jumlah Cicilan harus valid.");
            return;
        }
        
        if (isNaN(parseFloat(newTransaction.interestRate))) {
             alert("Suku Bunga tidak valid.");
             return;
        }

        transactions.push(newTransaction);
        saveTransactions(); 
        form.reset(); 
        estimateDiv.style.display = 'none'; 
        alert("Transaksi berhasil dicatat!");
        refreshAllPagesAndCurrentView();
        showPage('homePage'); 
    });
    
    // ===================================
    // 5. MANAJEMEN MULTI-PAGE
    // ===================================
    
    function showPage(pageId) {
        const pages = document.querySelectorAll('.page');
        const currentNav = document.querySelector(`.nav-item[data-page="${pageId}"]`);

        pages.forEach(page => page.classList.remove('active'));
        navItems.forEach(nav => nav.classList.remove('active'));

        document.getElementById(pageId).classList.add('active');
        if (currentNav) {
            currentNav.classList.add('active');
        }

        // Render data sesuai halaman
        if (pageId === 'homePage') {
            renderMainDashboard(); 
        } else if (pageId === 'piutangPage') {
            renderTransactionList('piutang', piutangListContainer);
        } else if (pageId === 'utangPage') {
            renderTransactionList('utang', utangListContainer);
        } else if (pageId === 'historyPage') { // KONDISI BARU
            renderHistoryList();
        } else if (pageId === 'summaryPage') {
             renderBalanceSummary();
        }
        
        if (pageId !== 'formPage') {
            estimateDiv.style.display = 'none';
        }
    }

    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const pageId = item.getAttribute('data-page');
            showPage(pageId);
        });
    });

    function refreshAllPagesAndCurrentView() {
        const activePageId = document.querySelector('.page.active').id;
        showPage(activePageId); 
    }
    
    // INISIALISASI APLIKASI
    loadTransactions(); 
    // Beri nilai 'aktif' jika transaksi lama belum memiliki status
    transactions.forEach(tx => {
        if (!tx.status) {
            tx.status = 'aktif';
            tx.lunasDate = null;
        }
    });
    saveTransactions();
    showPage('homePage'); 
</script>

</body>
</html>
