<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catatan Piutang & Utang</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #e9ecef;
            --card-background: #ffffff;
            --text-color: #333;
            --text-muted: #666;
            --border-color: #dee2e6;
            --header-height: 50px;
        }

        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden;
            font-size: 14px;
        }

        /* ---------------------------------- */
        /* HEADER & NAVIGATION */
        /* ---------------------------------- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            background-color: var(--primary-color);
            color: white;
            padding: 0 15px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.2em;
            margin: 0;
            font-weight: bold;
        }

        .menu-toggle {
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }

        /* ---------------------------------- */
        /* SIDE MENU (DRAWER) */
        /* ---------------------------------- */
        .side-menu-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
        }

        .side-menu-content {
            width: 70%;
            max-width: 300px;
            height: 100%;
            background-color: var(--card-background);
            position: absolute;
            top: 0;
            left: 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            padding-top: 20px;
        }
        
        .side-menu-header {
             padding: 15px;
             background-color: var(--primary-color);
             color: white;
             font-size: 1.2em;
             font-weight: bold;
             margin-bottom: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.1s;
        }
        
        .menu-item:first-of-type {
             border-top: 1px solid var(--border-color);
        }

        .menu-item:hover, .menu-item.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }

        .menu-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }
        
        .menu-footer {
             position: absolute;
             bottom: 0;
             width: 100%;
             padding: 15px;
             font-size: 0.8em;
             text-align: center;
             color: var(--text-muted);
        }

        /* ---------------------------------- */
        /* MAIN CONTENT & PAGES */
        /* ---------------------------------- */
        .main-content {
            padding-top: var(--header-height);
            height: calc(100% - var(--header-height));
            position: relative;
        }

        .page {
            display: none;
            padding: 15px;
            min-height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .page.active {
            display: block;
        }

        /* ---------------------------------- */
        /* HOME PAGE */
        /* ---------------------------------- */
        .dashboard-section {
            background-color: var(--card-background);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .dashboard-section h2 {
            font-size: 1.1em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .summary-dashboard {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .summary-card {
            background-color: var(--light-color);
            padding: 12px;
            border-radius: 6px;
            flex: 1 1 calc(50% - 10px);
            min-width: 140px;
            text-align: center;
        }
        
        .summary-card h3 {
             font-size: 0.9em;
             color: var(--text-muted);
             margin: 0 0 5px 0;
             font-weight: normal;
        }

        .summary-card p {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0;
        }

        .card-piutang {
            border-left: 5px solid var(--success-color);
        }
        
        .card-utang {
            border-left: 5px solid var(--danger-color);
        }
        
        .card-networth {
             flex: 1 1 100%;
             border-left: 5px solid var(--primary-color);
             margin-top: 5px;
        }
        
        .card-networth p {
            font-size: 1.4em;
        }

        .chart-container {
             height: 250px;
             position: relative;
        }

        /* ---------------------------------- */
        /* LISTS (Piutang, Utang, History) */
        /* ---------------------------------- */
        
        .list-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .list-controls input[type="text"] {
             flex-grow: 1;
             padding: 8px;
             border: 1px solid var(--border-color);
             border-radius: 4px;
             font-size: 1em;
        }
        
        .list-controls select {
             padding: 8px;
             border: 1px solid var(--border-color);
             border-radius: 4px;
        }

        .transaction-list-item {
            display: flex;
            align-items: center;
            background-color: var(--card-background);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: transform 0.1s;
            border-left: 5px solid transparent;
        }

        .transaction-list-item:active {
            transform: scale(0.99);
        }

        .transaction-list-item.piutang {
            border-left-color: var(--success-color);
        }

        .transaction-list-item.utang {
            border-left-color: var(--danger-color);
        }

        .avatar-icon {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1em;
            font-weight: bold;
            margin-right: 15px;
        }

        .info-section {
            flex-grow: 1;
        }
        
        .info-section strong {
             font-size: 1.1em;
             display: block;
             margin-bottom: 3px;
        }

        .amount-section {
            text-align: right;
            line-height: 1.3;
        }

        .remaining-amount {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .transaction-list-item.piutang .remaining-amount {
             color: var(--success-color);
        }
        
        .transaction-list-item.utang .remaining-amount {
             color: var(--danger-color);
        }

        .due-info {
            font-size: 0.8em;
            color: var(--text-muted);
        }
        
        .status-badge {
             font-size: 0.7em;
             padding: 3px 6px;
             border-radius: 4px;
             font-weight: bold;
             display: inline-block;
             margin-top: 5px;
        }
        
        .status-late {
             background-color: #f8d7da; /* light red */
             color: var(--danger-color);
        }
        
        .status-active {
             background-color: #cce5ff; /* light blue */
             color: var(--primary-color);
        }

        /* ---------------------------------- */
        /* FORM PAGE */
        /* ---------------------------------- */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }
        
        .form-group input[type="number"] {
             -moz-appearance: textfield; /* Firefox */
        }
        .form-group input::-webkit-outer-spin-button,
        .form-group input::-webkit-inner-spin-button {
             -webkit-appearance: none;
             margin: 0; /* Chrome, Safari, Edge */
        }

        .form-info {
            background-color: var(--info-color);
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* ---------------------------------- */
        /* DETAIL MODAL (Pop-up) */
        /* ---------------------------------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content-detail {
            background-color: var(--card-background);
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-btn {
            color: var(--text-muted);
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 20px;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--dark-color);
            text-decoration: none;
            cursor: pointer;
        }
        
        .modal-title {
             font-size: 1.2em;
             font-weight: bold;
             margin-bottom: 15px;
             border-bottom: 2px solid var(--border-color);
             padding-bottom: 5px;
        }

        .modal-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed var(--light-color);
            font-size: 0.95em;
        }
        
        .modal-detail-row span {
             color: var(--text-muted);
        }
        
        .modal-detail-row strong {
             font-weight: bold;
             text-align: right;
        }

        .payment-history-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .payment-history-list div {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dotted var(--light-color);
            font-size: 0.9em;
        }
        
        .modal-actions {
             margin-top: 20px;
             display: flex;
             flex-direction: column;
             gap: 10px;
        }
        
        .modal-actions button {
             padding: 10px;
        }
        
        /* ---------------------------------- */
        /* PAYMENT DATE MODAL */
        /* ---------------------------------- */
        #paymentDateModal {
             display: none;
             align-items: center; /* Center vertically */
             justify-content: center; /* Center horizontally */
             background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content-payment {
             background-color: var(--card-background);
             padding: 25px;
             border-radius: 8px;
             width: 80%;
             max-width: 350px;
             text-align: center;
        }
        
        .modal-content-payment h3 {
             margin-top: 0;
             font-size: 1.1em;
             color: var(--primary-color);
        }
        
        #paymentAmountDisplay {
             font-size: 1.2em;
             font-weight: bold;
             margin-bottom: 15px;
             color: var(--success-color);
        }
        
        #datePaidInput {
             margin-bottom: 20px;
        }
        
        .payment-modal-actions {
             display: flex;
             gap: 10px;
        }
        
        .payment-modal-actions button {
             flex: 1;
             padding: 10px;
        }
        
        /* ---------------------------------- */
        /* FAB (Floating Action Button) */
        /* ---------------------------------- */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 50px;
            font-size: 1.5em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 900;
            transition: transform 0.3s, opacity 0.3s;
            opacity: 0;
            transform: scale(0);
        }
        
        .fab.show {
             opacity: 1;
             transform: scale(1);
        }
        
        /* ---------------------------------- */
        /* SUMMARY PAGE */
        /* ---------------------------------- */
        .summary-page-content {
             display: flex;
             flex-direction: column;
             gap: 15px;
        }
        
        .summary-block {
             background-color: var(--card-background);
             padding: 15px;
             border-radius: 8px;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .summary-block h3 {
             font-size: 1em;
             color: var(--primary-color);
             margin-top: 0;
             border-bottom: 1px solid var(--border-color);
             padding-bottom: 5px;
             margin-bottom: 10px;
        }
        
        .summary-row {
             display: flex;
             justify-content: space-between;
             padding: 5px 0;
             font-size: 0.95em;
        }
        
        .summary-row span:first-child {
             color: var(--text-muted);
        }
        
        .summary-row strong {
             font-weight: bold;
        }
        
        .summary-row.networth strong {
             font-size: 1.2em;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </div>
        <h1>Catatan Keuangan</h1>
    </div>

    <div class="side-menu-modal" id="sideMenuModal">
        <div class="side-menu-content" id="sideMenuContent">
            <div class="side-menu-header">MENU UTAMA</div>
            <div class="menu-item active" data-page="homePage">
                <i class="fas fa-home"></i> Beranda
            </div>
            <div class="menu-item" data-page="piutangPage">
                <i class="fas fa-arrow-circle-up"></i> Daftar Piutang
            </div>
            <div class="menu-item" data-page="utangPage">
                <i class="fas fa-arrow-circle-down"></i> Daftar Utang
            </div>
            <div class="menu-item" data-page="formPage">
                <i class="fas fa-plus-circle"></i> Tambah Transaksi
            </div>
            <div class="menu-item" data-page="historyPage">
                <i class="fas fa-history"></i> Riwayat Lunas
            </div>
            <div class="menu-item" data-page="summaryPage">
                <i class="fas fa-chart-pie"></i> Ringkasan Total
            </div>
            <div class="menu-item" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> Export Data (CSV)
            </div>
            <div class="menu-footer">
                Versi 1.1
            </div>
        </div>
    </div>

    <div class="main-content">
        
        <div class="page active" id="homePage">
            <div class="dashboard-section">
                <h2>Ringkasan Keuangan Aktif</h2>
                <div class="summary-dashboard" id="mainDashboard">
                    </div>
            </div>

            <div class="dashboard-section">
                <h2>Distribusi Piutang & Utang</h2>
                <div class="chart-container">
                    <canvas id="piutangChart"></canvas>
                </div>
            </div>

            <div class="dashboard-section">
                <h2>Jatuh Tempo Mendekat (Aktif)</h2>
                <div id="latestTransactions">
                    </div>
            </div>
        </div>

        <div class="page" id="piutangPage">
            <h2>Daftar Piutang Aktif</h2>
            <div class="list-controls">
                 <input type="text" id="searchPiutang" placeholder="Cari nama..." onkeyup="filterTransactionList('piutang')">
                 <select id="sortPiutang" onchange="filterTransactionList('piutang')">
                     <option value="due_asc">Jatuh Tempo (Terdekat)</option>
                     <option value="due_desc">Jatuh Tempo (Terjauh)</option>
                     <option value="amount_desc">Sisa (Terbesar)</option>
                 </select>
            </div>
            <div id="piutangList">
                </div>
        </div>

        <div class="page" id="utangPage">
            <h2>Daftar Utang Aktif</h2>
            <div class="list-controls">
                 <input type="text" id="searchUtang" placeholder="Cari nama..." onkeyup="filterTransactionList('utang')">
                 <select id="sortUtang" onchange="filterTransactionList('utang')">
                     <option value="due_asc">Jatuh Tempo (Terdekat)</option>
                     <option value="due_desc">Jatuh Tempo (Terjauh)</option>
                     <option value="amount_desc">Sisa (Terbesar)</option>
                 </select>
            </div>
            <div id="utangList">
                </div>
        </div>
        
        <div class="page" id="historyPage">
            <h2>Riwayat Transaksi Lunas</h2>
            <div class="list-controls">
                 <input type="text" id="searchHistory" placeholder="Cari nama..." onkeyup="filterTransactionList('history')">
                 <select id="sortHistory" onchange="filterTransactionList('history')">
                     <option value="lunas_desc">Tanggal Lunas (Terbaru)</option>
                     <option value="principal_desc">Pokok (Terbesar)</option>
                 </select>
            </div>
            <div id="historyList">
                </div>
        </div>
        
        <div class="page" id="summaryPage">
            <h2>Ringkasan Total Keuangan</h2>
            <div class="summary-page-content">
                <div class="summary-block">
                    <h3>Total Piutang (Klaim)</h3>
                    <div class="summary-row">
                        <span>Total Awal (Lunas + Aktif):</span> 
                        <strong id="summaryPiutangAwal">Rp 0</strong>
                    </div>
                    <div class="summary-row">
                        <span>Sisa Piutang Aktif:</span> 
                        <strong style="color: var(--success-color);" id="summaryPiutangSisa">Rp 0</strong>
                    </div>
                </div>
                
                <div class="summary-block">
                    <h3>Total Utang (Kewajiban)</h3>
                    <div class="summary-row">
                        <span>Total Awal (Lunas + Aktif):</span> 
                        <strong id="summaryUtangAwal">Rp 0</strong>
                    </div>
                    <div class="summary-row">
                        <span>Sisa Utang Aktif:</span> 
                        <strong style="color: var(--danger-color);" id="summaryUtangSisa">Rp 0</strong>
                    </div>
                </div>
                
                <div class="summary-block">
                    <h3>Net Worth (Nilai Bersih)</h3>
                    <div class="summary-row networth">
                        <span>Net Worth Akhir (Piutang Sisa - Utang Sisa):</span> 
                        <strong id="summaryNetWorth">Rp 0</strong>
                    </div>
                </div>
                
                <button onclick="exportToCSV()" style="background-color: var(--secondary-color);">
                     <i class="fas fa-file-csv"></i> Export Semua Data ke CSV
                </button>
            </div>
        </div>


        <div class="page" id="formPage">
            <h2>Tambah Transaksi Baru</h2>
            <form id="transactionForm">
                <div class="form-group">
                    <label for="type">Tipe Transaksi:</label>
                    <select id="type" required>
                        <option value="piutang">Piutang (Orang berutang pada Anda)</option>
                        <option value="utang">Utang (Anda berutang pada orang)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="person">Nama Pihak Kedua:</label>
                    <input type="text" id="person" required placeholder="Nama orang/perusahaan">
                </div>
                
                <div class="form-group">
                    <label for="principal">Pokok Pinjaman (Rp):</label>
                    <input type="text" id="principal" required placeholder="Contoh: 1.000.000" oninput="formatInputRupiah(this); updateInstallmentEstimate();">
                </div>

                <div class="form-group">
                    <label for="interestRate">Suku Bunga (%) per Tenor (Flat):</label>
                    <input type="number" id="interestRate" required value="0" min="0" step="0.01" oninput="updateInstallmentEstimate()">
                    <div class="form-info">Tulis '0' jika tanpa bunga. Bunga dihitung dari Pokok Pinjaman.</div>
                </div>
                
                <div class="form-group">
                    <label for="installmentsCount">Tenor/Jumlah Cicilan (Bulan):</label>
                    <input type="number" id="installmentsCount" required min="1" value="1" oninput="updateInstallmentEstimate(); calculateDueDate();">
                    <div id="installmentEstimate" style="display: none; margin-top: 5px;"></div>
                </div>

                <div class="form-group">
                    <label for="startDate">Tanggal Mulai Pinjaman:</label>
                    <input type="date" id="startDate" required onchange="calculateDueDate()">
                </div>
                
                <div class="form-group form-info">
                    <label>Estimasi Tanggal Jatuh Tempo Akhir:</label>
                    <strong id="finalDueDateDisplay">Pilih tanggal mulai dan tenor/cicilan.</strong>
                </div>

                <button type="submit">Catat Transaksi</button>
            </form>
        </div>

    </div>
    
    <div class="fab" id="fabAddTransaction" onclick="navigateTo('formPage')">
        <i class="fas fa-plus"></i>
    </div>
    
    <div id="transactionDetailModal" class="modal">
        <div class="modal-content-detail">
            <span class="close-btn" onclick="closeDetailModal()">&times;</span>
            <div class="modal-title" id="modalTitle"></div>
            <div id="modalContent"></div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>
    
    <div id="paymentDateModal" class="modal">
        <div class="modal-content-payment">
            <h3>Catat Pembayaran</h3>
            <div id="paymentAmountDisplay" style="color: var(--success-color);"></div>
            <div class="form-group">
                <label for="datePaidInput">Tanggal Pembayaran:</label>
                <input type="date" id="datePaidInput" required>
            </div>
            <div class="payment-modal-actions">
                <button style="background-color: var(--secondary-color);" onclick="closePaymentModal()">Batal</button>
                <button id="confirmPaymentBtn" style="background-color: var(--success-color);">Konfirmasi Bayar</button>
            </div>
        </div>
    </div>


    <script>
    let transactions = [];
    const form = document.getElementById('transactionForm');
    const piutangListContainer = document.getElementById('piutangList');
    const utangListContainer = document.getElementById('utangList');
    const historyListContainer = document.getElementById('historyList'); 
    
    // VARIABEL UNTUK MENU SAMPING
    const menuToggle = document.getElementById('menuToggle');
    const sideMenuModal = document.getElementById('sideMenuModal');
    const sideMenuContent = document.getElementById('sideMenuContent');
    const menuItems = document.querySelectorAll('#sideMenuModal .menu-item');

    const principalInput = document.getElementById('principal');
    const interestRateInput = document.getElementById('interestRate');
    const installmentsCountInput = document.getElementById('installmentsCount');
    const startDateInput = document.getElementById('startDate'); 
    const finalDueDateDisplay = document.getElementById('finalDueDateDisplay'); 
    const estimateDiv = document.getElementById('installmentEstimate');
    
    // VARIABEL MODAL BARU
    const detailModal = document.getElementById('transactionDetailModal');
    const detailModalContent = document.getElementById('detailModalContent');
    const paymentModal = document.getElementById('paymentDateModal');
    const datePaidInput = document.getElementById('datePaidInput');
    const paymentAmountDisplay = document.getElementById('paymentAmountDisplay');
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    
    let currentTxId = null;
    let currentInstallmentAmount = 0;

    let piutangChartInstance = null; 

    // ===================================
    // 1. MANAJEMEN DATA & LOCAL STORAGE
    // ===================================

    function loadTransactions() {
        const storedTransactions = localStorage.getItem('personalFinanceTracker');
        if (storedTransactions) {
            transactions = JSON.parse(storedTransactions); 
        }
    }

    function saveTransactions() {
        localStorage.setItem('personalFinanceTracker', JSON.stringify(transactions));
    }
    
    // ===================================
    // 2. FUNGSI UTILITAS
    // ===================================

    function formatInputRupiah(inputElement) {
        let angka = inputElement.value.replace(/\D/g, ''); 
        if (!angka || angka === '0') {
            inputElement.value = '';
            return;
        }
        let formatted = new Intl.NumberFormat('id-ID').format(angka);
        inputElement.value = formatted;
    }

    function formatCurrency(amount) {
        const roundedAmount = Math.round(parseFloat(amount)); 
        return roundedAmount.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function cleanInterestRate(input) {
        return input.replace(/,/g, '.').replace(/[^0-9.]/g, ''); 
    }
    
    function cleanPrincipal(input) {
         return input.replace(/\./g, ''); 
    }

    function calculateTotal(principal, rate, installmentsCount) {
        const principalAmount = parseFloat(principal); 
        const interestRate = parseFloat(rate) / 100; 
        const installments = parseInt(installmentsCount);
        
        if (isNaN(principalAmount) || isNaN(interestRate) || isNaN(installments) || installments === 0) {
            return { totalInterest: 0, totalAmount: 0, totalPerInstallment: 0 };
        }
        
        const totalInterest = principalAmount * interestRate * installments;
        const totalAmount = principalAmount + totalInterest;
        const totalPerInstallment = totalAmount / installments;
        
        return {
            totalInterest: totalInterest,
            totalAmount: totalAmount,
            totalPerInstallment: totalPerInstallment,
        };
    }
    
    function getFinancialTotals() {
        let totalPiutangAwal = 0; 
        let sisaPiutang = 0;      
        let totalUtangAwal = 0;   
        let sisaUtang = 0;        

        // NEW: For chart data
        let piutangAktif = 0;
        let piutangLunas = 0;
        let utangAktif = 0;
        let utangLunas = 0;

        transactions.forEach(tx => { 
            const result = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = result.totalPerInstallment * remainingInstallments;

            if (tx.type === 'piutang') {
                totalPiutangAwal += result.totalAmount;
                if (tx.status === 'aktif') {
                    sisaPiutang += remainingTotal;
                    piutangAktif += remainingTotal; 
                } else {
                    piutangLunas += result.totalAmount; 
                }
            } else if (tx.type === 'utang') {
                totalUtangAwal += result.totalAmount;
                if (tx.status === 'aktif') {
                    sisaUtang += remainingTotal;
                    utangAktif += remainingTotal; 
                } else {
                    utangLunas += result.totalAmount; 
                }
            }
        });
        
        const netWorthAwal = totalPiutangAwal - totalUtangAwal;
        const netWorthAkhir = sisaPiutang - sisaUtang;
        
        return {
            totalPiutangAwal, sisaPiutang, 
            totalUtangAwal, sisaUtang,
            netWorthAwal, netWorthAkhir,
            piutangAktif, piutangLunas, utangAktif, utangLunas 
        };
    }
    
    function updateInstallmentEstimate() {
        const principalFormatted = principalInput.value;
        const principalClean = cleanPrincipal(principalFormatted); 
        const rateClean = cleanInterestRate(interestRateInput.value); 
        const installments = parseInt(installmentsCountInput.value);

        if (!principalClean || !rateClean || installments < 1) {
            estimateDiv.style.display = 'none';
            return;
        }

        const result = calculateTotal(principalClean, rateClean, installments);

        if (result.totalPerInstallment > 0) {
            estimateDiv.style.display = 'block';
            estimateDiv.innerHTML = `
                <p style="margin: 0; font-size: 0.9em; color:#0056b3;">
                    Estimasi Cicilan per Bulan (${installments}x): 
                    <strong style="font-size: 1.1em;">Rp ${formatCurrency(result.totalPerInstallment)}</strong>
                    <span style="font-size: 0.8em; color: #555;">(Total akhir: Rp ${formatCurrency(result.totalAmount)})</span>
                </p>
            `;
        } else {
             estimateDiv.style.display = 'none';
        }
    }
    
    function calculateDueDate() {
        const startDateValue = startDateInput.value;
        const installments = parseInt(installmentsCountInput.value);
        
        if (!startDateValue || installments < 1) {
            finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.';
            return '';
        }

        // Gunakan fungsi Date dengan T00:00:00 untuk menghindari masalah zona waktu
        const startDate = new Date(startDateValue + 'T00:00:00'); 
        
        if (isNaN(startDate)) {
            finalDueDateDisplay.textContent = 'Tanggal mulai tidak valid.';
            return '';
        }
        
        // --- LOGIKA PERHITUNGAN JATUH TEMPO AKHIR ---
        const finalDueDate = new Date(startDate);
        const startDay = startDate.getDate();
        
        // Set ke bulan berikutnya (installments - 1)
        // Jika tenor 1, maka 1-1=0, bulan tidak berubah (benar).
        // Jika tenor 3, maka 3-1=2, bulan maju 2 bulan (Oktober + 2 bulan = Desember). 
        // Harusnya: Oktober + 3 bulan = Januari. Jadi, harusnya + installments
        
        // KOREKSI: Tanggal jatuh tempo akhir adalah Tanggal Mulai + (Tenor - 1) bulan jika ini cicilan.
        // Tapi jika dilihat dari konteks cicilan 1/x, maka jatuh tempo *terakhir* adalah:
        // Tgl Mulai (Cicilan 1) -> Tgl Mulai + 1 bulan (Cicilan 2) -> ... -> Tgl Mulai + (N-1) bulan (Cicilan N).
        // Namun, jika tanggal mulai adalah T0, maka cicilan terakhir adalah T0 + (N-1) bulan.
        // Jika tanggal mulai adalah T1 (cicilan 1), maka cicilan terakhir adalah T1 + (N-1) bulan.
        // Contoh: Mulai 19 Okt (Cicilan 1), Tenor 3.
        // Cicilan 1: 19 Okt
        // Cicilan 2: 19 Nov
        // Cicilan 3: 19 Des
        // Jatuh tempo akhir: 19 Des. (Jika tenor 3x, artinya 3x pembayaran, dengan pembayaran terakhir di bulan ke-3)
        // Namun, user ingin 19 Okt + 3 bulan = 19 Jan. Ini berarti Cicilan 1 di Tgl Mulai + 1 bulan (yaitu 19 Nov).
        
        // ASUMSI BARU (Mengikuti Keinginan User):
        // Pembayaran Cicilan ke-1 dilakukan 1 bulan setelah Tanggal Mulai.
        // Jadi, Jatuh Tempo Akhir adalah Tanggal Mulai + Tenor bulan.
        
        // Perbaikan: Ubah logika agar menambah 'installments' bulan.
        finalDueDate.setMonth(finalDueDate.getMonth() + installments); 

        // Koreksi jika setMonth melompat bulan
        if (finalDueDate.getDate() < startDay && finalDueDate.getDate() !== 1) {
             // Jika tanggal yang dihasilkan lebih kecil dari hari awal (misal 31-Jan + 1 bulan = 3-Mar),
             // dan tanggal yang dihasilkan BUKAN tanggal 1 (misal 31-Mar + 1 bulan = 1-Mei, ini benar),
             // maka kita asumsikan lompatan terjadi karena hari tidak ada (misal 31 Feb) dan atur ke hari terakhir bulan
             finalDueDate.setDate(0); 
        }
        // --- AKHIR LOGIKA PERHITUNGAN JATUH TEMPO AKHIR ---

        const formattedDate = finalDueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        
        finalDueDateDisplay.textContent = formattedDate;
        
        // Format output YYYY-MM-DD
        const year = finalDueDate.getFullYear();
        const month = String(finalDueDate.getMonth() + 1).padStart(2, '0');
        const day = String(finalDueDate.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`; 
    }
    
    // FUNGSI INI DIPERBAIKI DENGAN LOGIKA KOREKSI LOMPATAN BULAN (Month Rollover)
    function calculateNextDueDate(tx) {
         const dateString = tx.startDate;
         
         if (tx.status !== 'aktif' || !dateString) return null;

         const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
         if (paidCount >= tx.installmentsCount) return null; 

         // 1. Buat objek Date dari tanggal mulai (diberi T00:00:00 untuk menghindari masalah zona waktu)
         const startDate = new Date(dateString + 'T00:00:00');
         const startDay = startDate.getDate();
         const startMonth = startDate.getMonth();
         const startYear = startDate.getFullYear();
         
         // 2. Hitung bulan jatuh tempo berikutnya (bulan awal + jumlah cicilan yang sudah dibayar + 1 bulan)
         // Jika paidCount = 0 (cicilan ke-1), nextDueDate harus maju 1 bulan.
         // Jika paidCount = 1 (cicilan ke-2), nextDueDate harus maju 2 bulan.
         // Jadi, kita hitung: startMonth + (paidCount + 1)
         
         const newMonth = startMonth + paidCount + 1; // +1 untuk maju ke bulan berikutnya (cicilan ke-n+1)
         
         // Buat tanggal baru dengan hari dan bulan yang sudah dihitung.
         // JavaScript akan otomatis menangani lompatan tahun (misal: bulan ke-12 menjadi tahun berikutnya, bulan ke-0)
         let nextDueDate = new Date(startYear, newMonth, startDay); 

         // 3. Koreksi jika setDate(startDay) menyebabkan lompatan bulan.
         
         // Hitung bulan yang diharapkan setelah modulo 12
         // newMonth adalah bulan ke-(n+1). Contoh: Okt (9) + 1 = 10 (Nov). Expected: 10 % 12 = 10.
         // Contoh: Jan (0) + 1 = 1 (Feb). Expected: 1 % 12 = 1.
         // Contoh: Des (11) + 1 = 12 (Jan tahun depan). Expected: 12 % 12 = 0.
         const expectedMonth = newMonth % 12;
         
         // nextDueDate.getMonth() akan otomatis menjadi 0 untuk Jan tahun depan.
         // Ini akan membandingkan: 0 vs 0 (OK) atau 1 vs 1 (OK).
         // Jika 31 Jan + 1 bulan = 3 Mar (getMonth() = 2), expectedMonth = 1 (Feb).
         if (nextDueDate.getMonth() !== expectedMonth) {
              // Jika terjadi lompatan, atur ke hari terakhir bulan yang diharapkan (expectedMonth).
              // new Date(tahun, expectedMonth + 1, 0) menghasilkan hari terakhir bulan 'expectedMonth'.
              nextDueDate = new Date(nextDueDate.getFullYear(), expectedMonth + 1, 0); 
         } 
         
         // Format output YYYY-MM-DD
         const year = nextDueDate.getFullYear();
         const month = String(nextDueDate.getMonth() + 1).padStart(2, '0');
         const day = String(nextDueDate.getDate()).padStart(2, '0');
         
         return `${year}-${month}-${day}`; 
    }
    
    // FUNGSI INI DIPERBAIKI UNTUK PERBANDINGAN TANGGAL YANG AKURAT
    function getDueStatus(dueDate) {
        if (!dueDate) return { badge: '', class: '' }; 

        const today = new Date();
        today.setHours(0, 0, 0, 0); // Hapus jam (tanggal hari ini yang bersih)
        
        // Buat tanggal jatuh tempo dari string YYYY-MM-DD. 
        // Menggunakan constructor Date(string + 'T00:00:00') penting untuk interpretasi zona waktu yang konsisten.
        const due = new Date(dueDate + 'T00:00:00'); 
        due.setHours(0, 0, 0, 0); // Hapus jam (tanggal jatuh tempo yang bersih)

        // Hitung selisih hari
        const diffTime = due.getTime() - today.getTime();
        // Gunakan Math.ceil() untuk memastikan selisih waktu yang kurang dari 24 jam (tapi di hari berikutnya)
        // dihitung sebagai 1 hari, dan jika sudah lewat (negatif), tetap dikonversi dengan benar.
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        if (diffDays < 0) {
            return { badge: `TERLAMBAT ${Math.abs(diffDays)} hari`, class: 'status-late' };
        } else if (diffDays === 0) {
            return { badge: 'JATUH TEMPO HARI INI', class: 'status-active' }; 
        } else if (diffDays <= 7) {
            return { badge: `JATUH TEMPO ${diffDays} hari lagi`, class: 'status-active' };
        } else {
            return { badge: 'AKTIF', class: 'status-active' };
        }
    }

    // ===================================
    // 3. FUNGSI RENDER
    // ===================================

    function renderSummaryCards() {
        const totals = getFinancialTotals();
        const mainDashboard = document.getElementById('mainDashboard');
        mainDashboard.innerHTML = `
            <div class="summary-card card-piutang">
                <h3>Sisa Piutang Aktif</h3>
                <p>Rp ${formatCurrency(totals.sisaPiutang)}</p>
            </div>
            <div class="summary-card card-utang">
                <h3>Sisa Utang Aktif</h3>
                <p>Rp ${formatCurrency(totals.sisaUtang)}</p>
            </div>
            <div class="summary-card card-networth">
                <h3>Net Worth (Bersih)</h3>
                <p style="color: ${totals.netWorthAkhir >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">Rp ${formatCurrency(totals.netWorthAkhir)}</p>
            </div>
        `;

        // Update Summary Page
        document.getElementById('summaryPiutangAwal').textContent = `Rp ${formatCurrency(totals.totalPiutangAwal)}`;
        document.getElementById('summaryPiutangSisa').textContent = `Rp ${formatCurrency(totals.sisaPiutang)}`;
        document.getElementById('summaryUtangAwal').textContent = `Rp ${formatCurrency(totals.totalUtangAwal)}`;
        document.getElementById('summaryUtangSisa').textContent = `Rp ${formatCurrency(totals.sisaUtang)}`;
        document.getElementById('summaryNetWorth').textContent = `Rp ${formatCurrency(totals.netWorthAkhir)}`;
        document.getElementById('summaryNetWorth').style.color = totals.netWorthAkhir >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
    }

    function renderTransactionList(type, containerId) {
        const container = document.getElementById(containerId);
        let listHtml = '';
        
        let filteredList;
        if (type === 'history') {
             filteredList = transactions.filter(tx => tx.status === 'lunas');
        } else {
             filteredList = transactions.filter(tx => tx.type === type && tx.status === 'aktif');
        }
        
        const searchQuery = document.getElementById(`search${type.charAt(0).toUpperCase() + type.slice(1)}`)?.value.toLowerCase() || '';
        if (searchQuery) {
            filteredList = filteredList.filter(tx => tx.person.toLowerCase().includes(searchQuery));
        }
        
        // Sorting
        const sortValue = document.getElementById(`sort${type.charAt(0).toUpperCase() + type.slice(1)}`)?.value;
        if (sortValue) {
            filteredList.sort((a, b) => sortTransactions(a, b, sortValue));
        } else if (type === 'history') {
            filteredList.sort((a, b) => new Date(b.dateCompleted) - new Date(a.dateCompleted)); // Default history sort
        } else {
             filteredList.sort((a, b) => { // Default active sort: due_asc
                const nextDueA = calculateNextDueDate(a) || '9999-12-31';
                const nextDueB = calculateNextDueDate(b) || '9999-12-31';
                return nextDueA.localeCompare(nextDueB);
            });
        }


        if (filteredList.length === 0) {
             container.innerHTML = `<p style="text-align: center; color: var(--text-muted);">Tidak ada ${type} ${type === 'history' ? 'yang lunas' : 'aktif'} yang tercatat.</p>`;
             return;
        }

        filteredList.forEach(tx => {
            const nextDueDate = calculateNextDueDate(tx);
            const dueStatus = getDueStatus(nextDueDate);
            const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = totals.totalPerInstallment * remainingInstallments;
            
            let amountDisplay;
            let dueInfo;
            let badge;
            
            // Konversi tanggal untuk tampilan
            const nextDueDisplay = nextDueDate ? new Date(nextDueDate + 'T00:00:00').toLocaleDateString('id-ID') : '-';
            const completedDateDisplay = tx.dateCompleted ? new Date(tx.dateCompleted + 'T00:00:00').toLocaleDateString('id-ID') : '-';

            if (tx.status === 'aktif') {
                amountDisplay = `<div class="remaining-amount">Rp ${formatCurrency(remainingTotal)}</div>`;
                dueInfo = `<div class="due-info">Cicilan ke ${paidCount + 1} (${tx.installmentsCount}x)</div>
                           <div class="due-info">Jatuh Tempo: ${nextDueDisplay}</div>`;
                badge = `<span class="status-badge ${dueStatus.class}">${dueStatus.badge}</span>`;
            } else { // Lunas
                amountDisplay = `<div class="remaining-amount" style="color:var(--success-color);">LUNAS</div>`;
                dueInfo = `<div class="due-info">Pokok: Rp ${formatCurrency(tx.principal)}</div>
                           <div class="due-info">Lunas: ${completedDateDisplay}</div>`;
                badge = `<span class="status-badge" style="background-color: #d4edda; color: var(--success-color);">SELESAI</span>`;
            }
            
            const initials = tx.person.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

            listHtml += `
                <div class="transaction-list-item ${tx.type}" data-id="${tx.id}" onclick="showDetailModal('${tx.id}')">
                    <div class="avatar-icon">${initials}</div>
                    <div class="info-section">
                        <strong>${tx.person}</strong>
                        <p style="margin: 3px 0 0;">${tx.type === 'piutang' ? 'MEMBERI PINJAMAN' : 'MENERIMA PINJAMAN'}</p>
                        ${badge}
                    </div>
                    <div class="amount-section">
                        ${amountDisplay}
                        ${dueInfo}
                    </div>
                </div>
            `;
        });

        container.innerHTML = listHtml;
    }
    
    function renderLatestTransactions() {
        const latestContainer = document.getElementById('latestTransactions');
        let activeList = transactions.filter(tx => tx.status === 'aktif');
        
        // Sort by next due date (ascending)
        activeList.sort((a, b) => {
             const nextDueA = calculateNextDueDate(a) || '9999-12-31';
             const nextDueB = calculateNextDueDate(b) || '9999-12-31';
             return nextDueA.localeCompare(nextDueB);
        });
        
        const limitedList = activeList.slice(0, 5); // Ambil 5 transaksi terbaru

        if (limitedList.length === 0) {
             latestContainer.innerHTML = `<p style="text-align: center; color: var(--text-muted);">Tidak ada transaksi aktif.</p>`;
             return;
        }
        
        let listHtml = '';
        limitedList.forEach(tx => {
            const nextDueDate = calculateNextDueDate(tx);
            const dueStatus = getDueStatus(nextDueDate);
            const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = totals.totalPerInstallment * remainingInstallments;
            
            const initials = tx.person.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            const nextDueDisplay = nextDueDate ? new Date(nextDueDate + 'T00:00:00').toLocaleDateString('id-ID') : '-';

            listHtml += `
                <div class="transaction-list-item ${tx.type}" data-id="${tx.id}" onclick="showDetailModal('${tx.id}')">
                    <div class="avatar-icon">${initials}</div>
                    <div class="info-section">
                        <strong>${tx.person}</strong>
                        <p style="margin: 3px 0 0; font-size: 0.9em;">
                           ${tx.type === 'piutang' ? 'Piutang' : 'Utang'} | Cicilan ${paidCount + 1} dari ${tx.installmentsCount}
                        </p>
                        <span class="status-badge ${dueStatus.class}" style="margin-top: 5px;">${dueStatus.badge}</span>
                    </div>
                    <div class="amount-section">
                        <div class="remaining-amount" style="color: ${tx.type === 'piutang' ? 'var(--success-color)' : 'var(--danger-color)'};">Rp ${formatCurrency(remainingTotal)}</div>
                        <div class="due-info">Jatuh Tempo: ${nextDueDisplay}</div>
                    </div>
                </div>
            `;
        });
        latestContainer.innerHTML = listHtml;
    }
    
    function renderChart() {
        const totals = getFinancialTotals();
        const ctx = document.getElementById('piutangChart').getContext('2d');
        
        if (piutangChartInstance) {
            piutangChartInstance.destroy();
        }

        const chartData = {
            labels: ['Piutang Aktif', 'Utang Aktif', 'Piutang Lunas', 'Utang Lunas'],
            datasets: [{
                data: [totals.piutangAktif, totals.utangAktif, totals.piutangLunas, totals.utangLunas],
                backgroundColor: [
                    '#28a745', 
                    '#dc3545', 
                    '#6fcd7e', 
                    '#ff7c7c'  
                ],
                hoverOffset: 10
            }]
        };

        piutangChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += 'Rp ' + formatCurrency(context.parsed);
                                }
                                return label;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, context) => {
                            if (value === 0) return '';
                            if (value / context.dataset.data.reduce((a, b) => a + b, 0) < 0.05) return ''; 
                            return 'Rp ' + formatCurrency(value);
                        },
                        color: '#fff',
                        font: { weight: 'bold', size: 10 }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // ===================================
    // 4. FUNGSI NAVIGASI & INTERAKSI
    // ===================================
    
    function navigateTo(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('#sideMenuContent .menu-item').forEach(item => {
             item.classList.remove('active');
             if (item.getAttribute('data-page') === pageId) {
                 item.classList.add('active');
             }
        });

        // FAB visibility logic
        const fab = document.getElementById('fabAddTransaction');
        if (pageId === 'homePage') {
            fab.classList.add('show');
        } else {
            fab.classList.remove('show');
        }

        // Trigger render when navigating to certain pages
        if (pageId === 'homePage') {
            renderSummaryCards();
            renderLatestTransactions();
            renderChart();
        } else if (pageId === 'piutangPage') {
             renderTransactionList('piutang', 'piutangList');
        } else if (pageId === 'utangPage') {
             renderTransactionList('utang', 'utangList');
        } else if (pageId === 'historyPage') {
             renderTransactionList('history', 'historyList');
        } else if (pageId === 'summaryPage') {
            renderSummaryCards(); 
        }
        
        closeSideMenu();
        
        // Push state for better back button handling (optional, but helps PWA/browser behavior)
        if(pageId !== 'homePage') {
            history.pushState({page: pageId}, pageId, `#${pageId}`);
        } else {
            // Jika kembali ke home, pastikan URL bersih atau handle sesuai kebutuhan PWA
            history.pushState({page: 'homePage'}, 'homePage', '#homePage');
        }
    }
    
    function sortTransactions(a, b, sortValue) {
        if (sortValue === 'due_asc') {
            const nextDueA = calculateNextDueDate(a) || '9999-12-31';
            const nextDueB = calculateNextDueDate(b) || '9999-12-31';
            return nextDueA.localeCompare(nextDueB);
        } else if (sortValue === 'due_desc') {
            const nextDueA = calculateNextDueDate(a) || '0000-01-01';
            const nextDueB = calculateNextDueDate(b) || '0000-01-01';
            return nextDueB.localeCompare(nextDueA);
        } else if (sortValue === 'amount_desc') {
            const totalsA = calculateTotal(a.principal, a.interestRate, a.installmentsCount);
            const remainingA = totalsA.totalPerInstallment * (a.installmentsCount - (a.paymentHistory ? a.paymentHistory.length : 0));
            const totalsB = calculateTotal(b.principal, b.interestRate, b.installmentsCount);
            const remainingB = totalsB.totalPerInstallment * (b.installmentsCount - (b.paymentHistory ? b.paymentHistory.length : 0));
            return remainingB - remainingA;
        } else if (sortValue === 'lunas_desc') {
            const dateA = a.dateCompleted || '0000-01-01';
            const dateB = b.dateCompleted || '0000-01-01';
            return dateB.localeCompare(dateA);
        } else if (sortValue === 'principal_desc') {
            return cleanPrincipal(b.principal) - cleanPrincipal(a.principal);
        }
    }

    function filterTransactionList(type) {
         renderTransactionList(type, `${type}List`);
    }

    function openSideMenu() {
        sideMenuModal.style.display = 'block';
        setTimeout(() => {
            sideMenuContent.style.transform = 'translateX(0)';
        }, 10);
    }

    function closeSideMenu() {
        sideMenuContent.style.transform = 'translateX(-100%)';
        setTimeout(() => {
            sideMenuModal.style.display = 'none';
        }, 300);
    }

    // ===================================
    // 5. FUNGSI FORM & MODAL
    // ===================================

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const principalClean = cleanPrincipal(principalInput.value);
        const rateClean = cleanInterestRate(interestRateInput.value); 
        const installments = parseInt(installmentsCountInput.value);
        const finalDueDate = calculateDueDate();

        if (principalClean <= 0 || rateClean < 0 || installments <= 0) {
            alert('Jumlah Pokok, Suku Bunga (>=0), dan Cicilan (>0) harus diisi dengan benar.');
            return;
        }

        const newTransaction = {
            id: Date.now().toString(),
            type: document.getElementById('type').value,
            person: document.getElementById('person').value,
            principal: principalClean,
            startDate: document.getElementById('startDate').value,
            interestRate: rateClean,
            installmentsCount: installments,
            status: 'aktif',
            dateCompleted: null,
            paymentHistory: []
        };

        transactions.unshift(newTransaction);
        saveTransactions();
        
        alert('Transaksi berhasil dicatat!'); 
        form.reset();
        finalDueDateDisplay.textContent = 'Pilih tanggal mulai dan tenor/cicilan.';
        estimateDiv.style.display = 'none';
        
        reRenderAllLists(); 
    });
    
    function showDetailModal(id) {
        const tx = transactions.find(t => t.id === id);
        if (!tx) return;
        
        // Simpan ID transaksi yang sedang dilihat
        detailModal.dataset.txId = id; 

        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalActions = document.getElementById('modalActions');
        
        const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
        const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
        const remainingInstallments = tx.installmentsCount - paidCount;
        const remainingTotal = totals.totalPerInstallment * remainingInstallments;
        const nextDueDate = calculateNextDueDate(tx);
        
        const nextDueDisplay = nextDueDate ? new Date(nextDueDate + 'T00:00:00').toLocaleDateString('id-ID') : '-';


        modalTitle.textContent = `${tx.type === 'piutang' ? 'Piutang' : 'Utang'} dengan ${tx.person}`;
        
        // Menambahkan tombol HAPUS di riwayat cicilan terakhir
        let historyHtml = tx.paymentHistory && tx.paymentHistory.length > 0
            ? tx.paymentHistory.map((p, index) => {
                const isLast = index === tx.paymentHistory.length - 1;
                const deleteButton = isLast && tx.status === 'aktif'
                    ? `<span style="color: var(--danger-color); cursor: pointer; font-size: 0.9em; margin-left: 10px;" onclick="cancelLastPayment('${tx.id}'); event.stopPropagation();"> [Batalkan]</span>`
                    : '';
                
                return `
                    <div>
                        <span>Cicilan ke-${index + 1} (${new Date(p.date + 'T00:00:00').toLocaleDateString('id-ID')})</span>
                        <strong>Rp ${formatCurrency(p.amount)}${deleteButton}</strong>
                    </div>
                `;
              }).join('')
            : '<p style="text-align: center; font-size: 0.9em; color: var(--text-muted);">Belum ada riwayat pembayaran.</p>';

        modalContent.innerHTML = `
            <div class="modal-detail-row"><span>Status:</span> <strong>${tx.status.toUpperCase()}</strong></div>
            <div class="modal-detail-row"><span>Pokok Pinjaman:</span> <strong>Rp ${formatCurrency(tx.principal)}</strong></div>
            <div class="modal-detail-row"><span>Total dengan Bunga (${tx.interestRate}%):</span> <strong>Rp ${formatCurrency(totals.totalAmount)}</strong></div>
            <div class="modal-detail-row"><span>Tenor/Cicilan:</span> <strong>${tx.installmentsCount} Bulan</strong></div>
            <div class="modal-detail-row"><span>Cicilan per Bulan:</span> <strong>Rp ${formatCurrency(totals.totalPerInstallment)}</strong></div>
            <hr style="margin: 10px 0;">
            <div class="modal-detail-row" style="font-size: 1.1em; font-weight: bold; color: ${tx.type === 'piutang' ? 'var(--success-color)' : 'var(--danger-color)'};">
                <span>Sisa Total:</span> <strong>Rp ${formatCurrency(remainingTotal)}</strong>
            </div>
            ${tx.status === 'aktif' ? `
                <div class="modal-detail-row"><span>Sisa Cicilan:</span> <strong>${remainingInstallments} dari ${tx.installmentsCount}</strong></div>
                <div class="modal-detail-row"><span>Jatuh Tempo Cicilan Berikut:</span> <strong>${nextDueDisplay}</strong></div>
            ` : ''}
            
            <h3>Riwayat Pembayaran (${paidCount}x)</h3>
            <div class="payment-history-list">${historyHtml}</div>
        `;

        modalActions.innerHTML = '';
        if (tx.status === 'aktif') {
            if (remainingInstallments > 0) {
                 // Ubah pemicu untuk memanggil modal input tanggal baru
                 modalActions.innerHTML += `<button style="background-color: var(--success-color);" onclick="openPaymentModal('${tx.id}', ${totals.totalPerInstallment})">Catat Pembayaran Cicilan (Rp ${formatCurrency(totals.totalPerInstallment)})</button>`;
            }
            modalActions.innerHTML += `<button style="background-color: var(--danger-color);" onclick="deleteTransaction('${tx.id}')">Hapus Transaksi</button>`;
        } else {
             modalActions.innerHTML += `<p style="text-align: center; color: var(--success-color); font-weight: bold;">Transaksi ini sudah LUNAS.</p>`;
             modalActions.innerHTML += `<button style="background-color: var(--danger-color);" onclick="deleteTransaction('${tx.id}')">Hapus Transaksi (Riwayat)</button>`;
        }
        
        detailModal.style.display = 'block';
    }
    
    function closeDetailModal() {
        document.getElementById('transactionDetailModal').style.display = 'none';
        // Hapus ID transaksi yang sedang dilihat
        detailModal.dataset.txId = ''; 
    }
    
    // FUNGSI BARU UNTUK MEMBUKA MODAL INPUT TANGGAL
    function openPaymentModal(id, installmentAmount) {
        // Tutup modal detail sebentar
        // closeDetailModal(); // Dihapus karena kita menggunakan openPaymentModal di dalam showDetailModal
        
        currentTxId = id;
        currentInstallmentAmount = installmentAmount;
        
        paymentAmountDisplay.textContent = `Cicilan sebesar: Rp ${formatCurrency(installmentAmount)}`;
        // Set tanggal hari ini sebagai default
        datePaidInput.value = new Date().toISOString().split('T')[0]; 
        
        paymentModal.style.display = 'flex'; // Gunakan flex untuk centering
    }
    
    // FUNGSI BARU UNTUK MENUTUP MODAL INPUT TANGGAL
    function closePaymentModal() {
        paymentModal.style.display = 'none';
        
        // Buka kembali modal detail setelah menutup modal pembayaran
        if (detailModal.dataset.txId) {
             showDetailModal(detailModal.dataset.txId);
        }
    }
    
    // EVENT LISTENER UNTUK TOMBOL OKE DI MODAL PEMBAYARAN
    confirmPaymentBtn.addEventListener('click', function() {
        const datePaid = datePaidInput.value;
        if (!datePaid) {
            alert('Tanggal pembayaran harus diisi.');
            return;
        }

        if (currentTxId && currentInstallmentAmount) {
             recordPayment(currentTxId, currentInstallmentAmount, datePaid);
        }
    });

    // FUNGSI UNTUK MENCATAT PEMBAYARAN
    function recordPayment(id, installmentAmount, datePaid) {
        const tx = transactions.find(t => t.id === id);
        if (!tx || tx.status !== 'aktif') return;

        tx.paymentHistory.push({
            date: datePaid,
            amount: installmentAmount
        });

        if (tx.paymentHistory.length >= tx.installmentsCount) {
            tx.status = 'lunas';
            tx.dateCompleted = datePaid; 
        }

        saveTransactions();
        alert(`Pembayaran cicilan ke-${tx.paymentHistory.length} tanggal ${new Date(datePaid + 'T00:00:00').toLocaleDateString('id-ID')} berhasil dicatat!`);
        
        closePaymentModal();
        reRenderAllLists();
    }
    
    function cancelLastPayment(id) {
        const tx = transactions.find(t => t.id === id);
        if (!tx || tx.status !== 'aktif' || !tx.paymentHistory || tx.paymentHistory.length === 0) {
            alert('Tidak ada pembayaran aktif yang dapat dibatalkan.');
            return;
        }

        if (!confirm(`Konfirmasi pembatalan/penghapusan cicilan terakhir (ke-${tx.paymentHistory.length})?`)) return;

        tx.paymentHistory.pop(); 
        
        // Pastikan status kembali aktif jika sudah lunas
        if (tx.status === 'lunas') {
            tx.status = 'aktif';
            tx.dateCompleted = null;
        }
        
        saveTransactions();
        alert('Pembayaran cicilan terakhir berhasil dibatalkan. Silakan input ulang jika terjadi kesalahan.');
        
        closeDetailModal();
        reRenderAllLists(); 
        setTimeout(() => showDetailModal(id), 300); 
    }
    
    function deleteTransaction(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini? Aksi ini tidak dapat dibatalkan.')) return;

        transactions = transactions.filter(t => t.id !== id);
        saveTransactions();
        alert('Transaksi berhasil dihapus.');
        closeDetailModal();
        reRenderAllLists();
    }
    
    // ===================================
    // 6. FUNGSI UTAMA & INITIALIZATION
    // ===================================
    
    function reRenderAllLists() {
        renderSummaryCards();
        renderChart();
        renderLatestTransactions();
        
        const activePageId = document.querySelector('.page.active')?.id; 
        
        if (activePageId === 'piutangPage') renderTransactionList('piutang', 'piutangList');
        if (activePageId === 'utangPage') renderTransactionList('utang', 'utangList');
        if (activePageId === 'historyPage') renderTransactionList('history', 'historyList');
        if (activePageId === 'homePage') {
            renderSummaryCards();
            renderLatestTransactions();
            renderChart();
        }
        if (activePageId === 'summaryPage') renderSummaryCards();
        
        if (activePageId === 'formPage') {
             document.getElementById('transactionForm').reset();
             document.getElementById('finalDueDateDisplay').textContent = 'Pilih tanggal mulai dan tenor/cicilan.';
             document.getElementById('installmentEstimate').style.display = 'none';
        }
    }

    function exportToCSV() {
        if (transactions.length === 0) {
            alert('Tidak ada data untuk diexport.');
            return;
        }

        let csv = 'ID,Tipe,Orang,Pokok (Rp),Tgl Mulai,Bunga (%),Tenor (Bulan),Total Akhir (Rp),Sisa (Rp),Status,Tgl Lunas,Riwayat Pembayaran\n';

        transactions.forEach(tx => {
            const totals = calculateTotal(tx.principal, tx.interestRate, tx.installmentsCount);
            const paidCount = tx.paymentHistory ? tx.paymentHistory.length : 0;
            const remainingInstallments = tx.installmentsCount - paidCount;
            const remainingTotal = totals.totalPerInstallment * remainingInstallments;
            
            const paymentDetails = tx.paymentHistory 
                ? tx.paymentHistory.map((p, i) => `Cicilan ${i+1}: Rp${Math.round(p.amount)} (${p.date})`).join(';')
                : '';

            const row = [
                tx.id,
                tx.type,
                `"${tx.person.replace(/"/g, '""')}"`, 
                tx.principal,
                tx.startDate,
                tx.interestRate,
                tx.installmentsCount,
                Math.round(totals.totalAmount),
                Math.round(remainingTotal),
                tx.status,
                tx.dateCompleted || '',
                `"${paymentDetails.replace(/"/g, '""')}"`
            ].join(',');
            
            csv += row + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "catatan_hutang_piutang_export_" + new Date().toISOString().split('T')[0] + ".csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Data berhasil diexport ke CSV!');
        }
    }

    // --- LOGIKA TOMBOL KEMBALI & KLIK DI LUAR MODAL (TIDAK BERUBAH DARI SEBELUMNYA) ---
    
    function handleBackKey(event) {
        // Cek jika ini adalah tombol Escape (untuk desktop/PWA) atau event backbutton (untuk Android/Hybrid)
        if (event.key === 'Escape' || event.type === 'backbutton') {
            
            // PENTING: Mencegah tindakan default browser (misalnya back)
            if (event.type === 'backbutton') event.preventDefault(); 
            
            // Prioritas 1: Tutup Modal Input Tanggal Cicilan
            if (paymentModal.style.display === 'flex') {
                closePaymentModal();
                return; 
            } 
            
            // Prioritas 2: Tutup Modal Detail Transaksi
            else if (detailModal.style.display === 'block') {
                closeDetailModal();
                return; 
            } 
            
            // Prioritas 3: Tutup Menu Samping
            else if (sideMenuModal.style.display === 'block') {
                closeSideMenu();
                return; 
            }
            
            // Prioritas 4: Navigasi/Keluar Aplikasi
            else {
                 handleBackButton();
            }
        }
    }
    
    function handleBackButton() {
        const activePageId = document.querySelector('.page.active')?.id; 
        
        // Hanya navigasi kembali ke 'homePage' jika tidak di 'homePage'
        if (activePageId && activePageId !== 'homePage') {
            navigateTo('homePage');
        } else {
            // Jika sudah di 'homePage', tanyakan untuk keluar
            if (confirm("Apakah Anda yakin ingin keluar dari aplikasi?")) {
                // Di lingkungan Hybrid/Cordova/Capacitor, gunakan kode khusus
                if (typeof navigator.app !== 'undefined' && typeof navigator.app.exitApp === 'function') {
                    navigator.app.exitApp(); 
                } else {
                    // Di browser/PWA, biarkan tombol back berfungsi (atau kembali ke state sebelumnya)
                    history.back(); 
                }
            }
        }
    }
    

    // Listener untuk klik di luar area modal detail
    detailModal.addEventListener('click', function(e) {
        if (e.target.id === 'transactionDetailModal') {
            closeDetailModal();
        }
    });
    
    // Listener untuk klik di luar area modal pembayaran
    paymentModal.addEventListener('click', function(e) {
        if (e.target.id === 'paymentDateModal') {
            closePaymentModal();
        }
    });
    

    document.addEventListener('DOMContentLoaded', () => {
        loadTransactions();
        reRenderAllLists(); 
        calculateDueDate(); 

        menuToggle.addEventListener('click', openSideMenu);
        sideMenuModal.addEventListener('click', (e) => {
            if (e.target.id === 'sideMenuModal') {
                closeSideMenu();
            }
        });
        
        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.getAttribute('data-page');
                navigateTo(pageId);
            });
        });
        
        // --- INIALISASI FAB ---
        document.getElementById('fabAddTransaction').classList.add('show');
        
        // --- START LOGIKA TOMBOL KEMBALI & ESCAPE KEY ---
        
        window.addEventListener('popstate', function(event) {
             closeSideMenu(); 
             
             const hash = window.location.hash.replace('#', '');
             const targetPage = hash || 'homePage';
             
             if (document.getElementById(targetPage)) {
                 document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                 document.getElementById(targetPage).classList.add('active');
                 reRenderAllLists(); 
             }
        });

        // Listener untuk lingkungan Cordova/Capacitor/Webview (backbutton event)
        if (typeof document.addEventListener === 'function') {
            // Daftarkan listener 'backbutton' yang akan dipicu oleh gesture kembali Android
            document.addEventListener('backbutton', handleBackKey, false);
            // Daftarkan listener 'keydown' untuk tombol Escape (untuk desktop/PWA)
            document.addEventListener('keydown', handleBackKey);
        }

        // Penanganan inisial load berdasarkan URL hash
        const initialPage = window.location.hash.replace('#', '') || 'homePage';
        navigateTo(initialPage);
        
        // --- END LOGIKA TOMBOL KEMBALI & ESCAPE KEY ---
    });
    </script>
</body>
</html>
